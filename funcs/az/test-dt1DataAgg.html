<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.0/css/jquery.dataTables.css">
  <!-- CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">


  <!-- JavaScript Bundle with Popper -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.12.0/js/jquery.dataTables.min.js"></script>
  <!-- <script src="https://cdn.datatables.net/1.12.0/js/dataTables.bootstrap5.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
    crossorigin="anonymous"></script>
  <script type="text/javascript" charset="utf8"
    src="https://cdn.datatables.net/1.12.0/js/jquery.dataTables.js"></script>


  <style>
    .custom-tooltip {
      --bs-tooltip-bg: var(--bs-primary);
    }

    .btn:focus {
      outline: none;
    }
  </style>
  <title>Data Aggregator</title>
</head>

<body>

  <div class="container mt-4">

    <button id="toggler">Toggler</button>

    <button id="testPaste">Paster</button>


    <div class="mb-3">
      <label for="formFile" class="form-label">Select File for Processing</label>
      <input class="form-control" type="file" id="file-input" />
    </div>


    <div>

      <button type="button" id="uniqueApps-save" class="btn btn-outline-primary d-none uniqueApps"
        data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip">
        Save Unique App List
      </button>
      <button type="button" id="uniqueApps-copy" class="btn btn-outline-primary d-none uniqueApps"
        data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip">
        Copy Unique App List to Clipboard
      </button>


    </div>
    <pre id="file-details"></pre>

    <div class="container d-flex justify-content-center d-none" id="loadingfile">
      <div class="spinner-grow text-primary m-3" role="status"></div>
    </div>



    <!-- <div class="d-none">
      <table id="datatable" class="" style="width:100%">
        <thead>
          <tr>
            <th></th>
            <th>Name</th>
            <th>Ag UID</th>
            <th>Env UID</th>
            <th>Email</th>
          </tr>
        </thead>
        <tfoot>
          <tr>
            <th></th>
            <th>Name</th>
            <th>Ag UID</th>
            <th>Env UID</th>
            <th>Email</th>
          </tr>
        </tfoot>
      </table>
    </div> -->
    <div class="">
      <table id="appDatatable" class="display compact" style="width:100%">
        <thead>
          <tr>
            <th>Domain</th>
            <th>Username</th>
            <th>Machine ID</th>
            <th>Application</th>
          </tr>
        </thead>
        <tfoot>
          <tr>
            <th>Domain</th>
            <th>Username</th>
            <th>Machine ID</th>
            <th>Application</th>
          </tr>
        </tfoot>
      </table>
    </div>


  </div>









  <script>
    $(document).ready(function () {
      let uniqueApplicationsCsv = []
      let data = ''
      const reader = new FileReader()





      function formatBytes(bytes, decimals) {
        if (bytes == 0) return '0 Bytes';
        var k = 1024,
          dm = decimals || 2,
          sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
          i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
      }

      $("#toggler").on('click', () => {
        $("#loadingfile").toggleClass('d-none')
      })


      $("#file-input").on('change', () => {
        $("#loadingfile").toggleClass('d-none', false)
        const file = document.querySelector("#file-input").files[0]


        reader.readAsText(file)
        reader.addEventListener('load', function (e) {
          $("#loadingfile").toggleClass('d-none', true)
          $(".uniqueApps").toggleClass('d-none', false)
          $("#file-details").text(`
              File Name: ${file.name}
              File Size: ${formatBytes(file.size)}
              `)
          const text = e.target.result.toString().split('\n').slice(1)
          const dataArray = text.map(item => item.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)).filter(i => i.length > 2)
          const uniqueApplications = [...new Set(text.map(item => item.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)[2]).filter(i => i != null))]
          uniqueApplicationsArray = uniqueApplications.map(item => item.replaceAll(',', '').replaceAll('"', '')).sort()
          uniqueApplicationsCsv = uniqueApplicationsArray.join('\r\n')
          // console.log(text)
          console.log(dataArray)

          const aggregatedData = dataArray.map(item => {
            let data = item[0].split('\\\\').join().split(',')
            // console.log(data)

            const obj = {
              domain: data[0],
              username: data[1],
              machineId: item[1],
              application: item[2],
              totalTimeSecons: item[3],
              timeActive: item[4]
            }
            return obj
          })
          // console.log(aggregatedData)


          $('#appDatatable').DataTable({
            data: aggregatedData,
            columns: [
              {data: "domain"},
              {data: "username"},
              {data: "machineId"},
              {data: "application"}
            ]
          })
        });
      })

      $('.uniqueApps').attr('title', "CSV Columns: user, machine, displayname, totaltimeseconds, timeactive")
      $('#uniqueApps-save').on('click', () => window.open("data:text/csv;charset=utf-8," + uniqueApplicationsCsv))
      $('#uniqueApps-copy').on('click', () => navigator.clipboard.writeText(uniqueApplicationsCsv))
      $('#testPaste').on('click', async () => {
        data = await navigator.clipboard.readText()
          console.log(data)
          $(".uniqueApps").toggleClass('d-none', false)
      })

      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>





</body>

</html>
